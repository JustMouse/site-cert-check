<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Certificate Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        // Обработчик клика по строке
        document.querySelectorAll('#certTable tr').forEach(row => {
            row.addEventListener('click', function() {
                const domain = this.cells[0].textContent.trim();
                fetch(`/update/${encodeURIComponent(domain)}`)
                    .then(() => {
                        this.classList.add('updating');
                        this.querySelector('.status').textContent = 'Updating...';
                    });
            });
        });
    
        // Обработчик фильтров
        document.querySelectorAll('.filters a').forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.search = new URLSearchParams({
                    filter: this.href.split('=')[1],
                    query: "{{ query }}"
                });
            });
        });
    </script>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; }
        .status-valid { color: green; }
        .status-error { color: red; }
        .status-updating { background: #fff3cd; }
        .progress { height: 5px; background: #4CAF50; transition: width 0.3s; }
    </style>
    <style>
        /* Добавленные стили */
        .controls { margin: 20px 0; display: flex; gap: 15px; align-items: center; }
        .filters a {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
        }
        .filters a.active { background: #4CAF50; color: white; }
        tr { cursor: pointer; transition: background 0.3s; }
        tr:hover { background: #f5f5f5; }
        tr.updating { background: #fff3cd; }
        .status-updating { color: orange; }
    </style>
</head>
<body>
    <h1>Certificate Monitoring</h1>
    
    <!-- Поиск и фильтры -->
    <div class="controls">
        <!-- Фильтры -->
        <div class="filters">
            <a href="?filter=all" class="{% if current_filter == 'all' %}active{% endif %}">All</a>
            <a href="?filter=valid" class="{% if current_filter == 'valid' %}active{% endif %}">Valid</a>
            <a href="?filter=error" class="{% if current_filter == 'error' %}active{% endif %}">Errors</a>
            <a href="?filter=pending" class="{% if current_filter == 'pending' %}active{% endif %}">Pending</a>
            <a href="?filter=never" class="{% if current_filter == 'never' %}active{% endif %}">Never Checked</a>
        </div>
        
        <!-- Поиск -->
        <form class="search-form">
            <input type="text" name="query" placeholder="Search domains..." value="{{ query }}">
            <input type="hidden" name="filter" value="{{ current_filter }}">
            <button type="submit">Search</button>
        </form>
    </div>

    <!-- Загрузка файла -->
    <form method="post" enctype="multipart/form-data" style="margin: 20px 0;">
        <input type="file" name="file">
        <button type="submit">Upload DNS Dump</button>
    </form>
    
    <!-- Кнопка обновления -->
    <button onclick="startUpdate()">Update All Certificates</button>
    <div class="progress" id="progress"></div>
    
    <!-- Таблица -->
    <table>
        <thead>
            <tr>
                <th>Domain</th>
                <th>Expiry Date</th>
                <th>Last Checked</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="certTable">
            {% for cert in certs %}
            <tr id="row-{{ cert.domain }}">
                <td>{{ cert.domain }}</td>
                <td>{{ cert.expiry_date.strftime('%Y-%m-%d %H:%M:%S') if cert.expiry_date else 'N/A' }}</td>
                <td>{{ cert.last_checked.strftime('%Y-%m-%d %H:%M:%S') if cert.last_checked else 'Never' }}</td>
                <td class="status-{{ cert.status.lower() }}">{{ cert.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const socket = io();
        let total = 0;
        let processed = 0;
        
        socket.on('update', (data) => {
            const row = document.getElementById(`row-${data.domain}`);
            if (row) {
                row.innerHTML = `
                    <td>${data.domain}</td>
                    <td>${data.expiry_date}</td>
                    <td>${data.last_checked}</td>
                    <td class="status-${data.status}">${data.status.toUpperCase()}</td>
                `;
            }
            updateProgress(++processed);
        });

        function startUpdate() {
            processed = 0;
            total = document.querySelectorAll('#certTable tr').length;
            document.getElementById('progress').style.width = '0%';
            fetch('/update_all', { method: 'POST' });
        }

        function updateProgress(count) {
            const progress = (count / total) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }
    </script>
</body>
</html>